<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SL Skill Hub</title>

  <!-- Firebase compat builds -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <style>
   :root {
     --header-color: #123249;
     --button-color: #447794;
     --bg-color: #E9B48A;
     --text-color: #061222;
     --card-bg: #fff;
   }
   *{box-sizing:border-box;}
   body{
     font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
     margin:0;
     background:var(--bg-color);
     color:var(--text-color);
     display:flex;
     flex-direction:column;
     min-height:100vh;
   }
   header{
     background:var(--header-color);
     color:var(--card-bg);
     padding:18px 12px;
     position:relative;
   }
   header h1{margin:0;font-size:34px;text-align:center;}
   header .intro{margin-top:8px;text-align:center;font-weight:700;font-size:18px;color:rgba(255,255,255,.95);}
   #userBox{position:absolute;left:14px;top:12px;text-align:left;color:#fff;}
   #userBox img{width:44px;height:44px;border-radius:50%;display:block;margin-bottom:6px;}
   #userBox .name{font-weight:700;margin-bottom:6px;}
   #userBox button{display:block;background:#fff;color:var(--header-color);border:none;padding:6px 10px;border-radius:6px;cursor:pointer;margin-bottom:6px;}
   .header-controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px;}
   .header-controls button,.header-controls input[type=search],.header-controls select{
     padding:10px 14px;border-radius:8px;border:0;font-size:14px;
   }
   .header-controls button{background:var(--button-color);color:var(--card-bg);font-weight:700;cursor:pointer;}
   .header-controls input[type=search]{flex:1;min-width:180px;}
   .header-controls select{min-width:140px;}
   main{
     flex:1;
     display:flex;
     flex-direction:column;
     align-items:center;
     padding:20px 12px 80px;
   }
   #formWrapper{
     width:100%;
     max-width:520px;
     margin:0 auto 20px;
     display:none;
   }
   form.skill-form{
     background:var(--card-bg);
     padding:20px;
     border-radius:8px;
     box-shadow:0 6px 18px rgba(0,0,0,.06);
   }
   .skill-form label{font-weight:600;margin-bottom:4px;display:block;}
   .skill-form input,.skill-form select{
     width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ddd;
   }
   .skill-form .row{display:flex;gap:10px;}
   .skill-form .row input{flex:1;}
   .skill-form button{background:var(--button-color);color:var(--card-bg);border:0;padding:10px 14px;border-radius:6px;cursor:pointer;font-weight:700;}
   #photoPreview{
     width:80px;height:80px;border-radius:50%;object-fit:cover;display:none;margin:10px auto;
   }
   #skillsArea{
     width:100%;
     max-width:900px;
     display:flex;
     flex-wrap:wrap;
     gap:14px;
     justify-content:center;
   }
   .card{
     width:320px;
     background:var(--card-bg);
     border-radius:8px;
     padding:14px;
     box-shadow:0 6px 18px rgba(0,0,0,.05);
     border:1px solid #eee;
     cursor:pointer;
     transition:transform .2s;
   }
   .card:hover{transform:translateY(-2px);}
   .card .top{display:flex;gap:12px;align-items:center;}
   .card img{width:56px;height:56px;border-radius:50%;object-fit:cover;}
   .card h3{margin:0;color:var(--header-color);}
   .card p{margin:6px 0;color:#333;}
   .card .small{font-size:13px;color:#666;}
   .card .actions{margin-top:10px;}
   .card .actions button{margin-right:8px;padding:6px 10px;border-radius:6px;border:0;cursor:pointer;}
   .btn-edit{background:orange;color:#fff;}
   .btn-delete{background:#e53935;color:#fff;}
   #shareBtn{
     position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;
     background:var(--button-color);border:none;color:var(--card-bg);font-size:26px;cursor:pointer;
     box-shadow:0 6px 12px rgba(0,0,0,.25);
   }
   @media (max-width:520px){
     .header-controls input[type=search]{width:180px;}
     .card{width:90%;}
     #userBox img{width:28px;height:28px;margin-bottom:4px;}
     #userBox .name{font-size:12px;margin-bottom:4px;}
     #userBox button{padding:4px 6px;font-size:12px;margin-bottom:4px;}
   }
   #profileView{
     display:none;
     padding:20px;
     max-width:800px;
     margin:auto;
     background:var(--card-bg);
     border-radius:8px;
     box-shadow:0 6px 18px rgba(0,0,0,.05);
     margin-top:20px;
   }
   .profile-header{display:flex;align-items:center;gap:20px;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #eee;}
   .profile-header img{width:100px;height:100px;border-radius:50%;object-fit:cover;}
   .profile-info h2{margin:0 0 10px 0;color:var(--header-color);font-size:28px;}
   .profile-info p{margin:5px 0;font-size:16px;color:var(--text-color);}
   .profile-skills{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px;margin-top:20px;}
   .profile-skill-card{background:#f8f9fa;padding:15px;border-radius:8px;border:1px solid #ddd;}
   .profile-skill-card h4{margin:0 0 8px 0;color:var(--header-color);font-size:18px;}
   .profile-skill-card p{margin:4px 0;font-size:14px;color:var(--text-color);}
   .back-btn{background:var(--button-color);color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:700;margin-bottom:20px;}
   .back-btn:hover{opacity:.9;}
  </style>
</head>
<body>
  <header>
    <div id="userBox">
      <img id="userPhoto" src="" alt="profile" style="display:none" />
      <div id="userName" class="name" style="display:none"></div>
      <button id="loginBtn">Login with Google</button>
      <button id="logoutBtn" style="display:none">Logout</button>
    </div>
    <h1>SL Skill Hub</h1>
    <div class="intro">Find talented people near you</div>
    <div class="header-controls">
      <button id="openAddBtn">Add Skill</button>
      <button id="addCategoryBtn" style="display:none">Add Category</button>
      <input id="searchInput" type="search" placeholder="Search by name, skill or location…" />
      <select id="filterCategory">
        <option value="">All categories</option>
      </select>
    </div>
  </header>

  <main>
    <div id="formWrapper">
      <form id="skillForm" class="skill-form">
        <input type="hidden" id="skillId" value="">
        <input id="name" placeholder="Your name" required />
        <input id="skill" placeholder="Your skill" required />
        <input id="location" placeholder="Location (eg: Freetown)" required />
        <input id="whatsapp" placeholder="WhatsApp number (eg: +2327... or 07...)" required />
        <select id="categorySelect" required>
          <option value="">Select category</option>
        </select>
        <label for="photoUpload">Profile Photo:</label>
        <img id="photoPreview" src="" alt="Preview" style="display:none;" />
        <input type="file" id="photoUpload" accept="image/*" />
        <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:8px">
          <button type="submit" id="saveBtn">Save</button>
        </div>
      </form>
    </div>

    <section id="skillsArea"></section>

    <div id="profileView" style="display:none;">
      <button onclick="closeProfile()" class="back-btn">← Back to Skills</button>
      <div id="profileContent"></div>
    </div>
  </main>

  <button id="shareBtn">⤴</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBWy9ffEDL3OugOpRbHrvDjGbQ3fkPGU4Y",
      authDomain: "sl-skills-hub.firebaseapp.com",
      projectId: "sl-skills-hub",
      storageBucket: "sl-skills-hub.appspot.com",
      messagingSenderId: "125049368940",
      appId: "1:125049368940:web:76d4a47aa9eb7c43914349"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
    const auth = firebase.auth();
    const db = firebase.firestore();

    const photoUpload = document.getElementById('photoUpload');
    const photoPreview = document.getElementById('photoPreview');
    photoUpload.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          photoPreview.src = ev.target.result;
          photoPreview.style.display = 'block';
        };
        reader.readAsDataURL(e.target.files[0]);
      } else {
        photoPreview.style.display = 'none';
      }
    });

    let currentUser = null;
    function normalizeWhatsApp(input){
      if(!input) return "";
      input=input.trim();
      if(input.startsWith("https://wa.me/")||input.startsWith("http://wa.me/")) return input;
      let digits=input.replace(/\D/g,"");
      if(digits.length && digits[0]==="0") digits="232"+digits.slice(1);
      if(!digits.startsWith("232")){ if(digits.length<=9) digits="232"+digits; }
      return "https://wa.me/"+digits;
    }
    function formatDate(ts){
      if(!ts) return "Date not available";
      try{ if(ts.toDate) return ts.toDate().toLocaleString();
        const d=new Date(ts);
        return isNaN(d)?String(ts):d.toLocaleString();
      }catch(e){ return String(ts);}
    }

    const loginBtn=document.getElementById('loginBtn');
    const logoutBtn=document.getElementById('logoutBtn');
    const userPhoto=document.getElementById('userPhoto');
    const userName=document.getElementById('userName');
    const openAddBtn=document.getElementById('openAddBtn');
    const searchInput=document.getElementById('searchInput');
    const addCategoryBtn=document.getElementById('addCategoryBtn');
    const categorySelect=document.getElementById('categorySelect');
    const shareBtn=document.getElementById('shareBtn');
    const filterCategory = document.getElementById('filterCategory');

    function loadCategories() {
      db.collection('categories').orderBy('name','asc')
        .onSnapshot(snap => {
          const opts=[...snap.docs].map(d=>d.data().name);
          categorySelect.innerHTML = '<option value="">Select category</option>';
          filterCategory.innerHTML = '<option value="">All categories</option>';
          opts.forEach(name=>{
            const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
            categorySelect.appendChild(opt);
            const filterOpt = document.createElement('option'); filterOpt.value = name; filterOpt.textContent = name;
            filterCategory.appendChild(filterOpt);
          });
        });
    }

    loginBtn.addEventListener('click', ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).then(result => {
        currentUser = result.user;
        userPhoto.src = currentUser.photoURL || "";
        userPhoto.style.display = currentUser.photoURL ? "block" : "none";
        userName.textContent = currentUser.displayName || currentUser.email;
        userName.style.display = "block";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        alert("Welcome " + currentUser.displayName);
        loadSkills();
      }).catch(error => {
        console.error(error);
        alert("Login failed: " + error.message);
      });
    });

    logoutBtn.addEventListener('click', ()=>auth.signOut());

    auth.onAuthStateChanged(user=>{
      currentUser=user;
      if(user){
        loginBtn.style.display='none';
        logoutBtn.style.display='inline-block';
        userPhoto.src=user.photoURL||"";
        userPhoto.style.display=user.photoURL?'block':'none';
        userName.textContent=user.displayName||user.email;
        userName.style.display='block';
        addCategoryBtn.style.display=(user.uid==='I5WY1FJzNibUDOCzCBdGWPtX9Nj1')?'inline-block':'none';
        loadCategories();
      } else {
        loginBtn.style.display='inline-block';
        logoutBtn.style.display='none';
        userPhoto.style.display='none';
        userName.style.display='none';
        addCategoryBtn.style.display='none';
      }
      loadSkills();
    });

    addCategoryBtn.addEventListener('click', async ()=>{
      const name=prompt("Enter new category name:");
      if(!name) return;
      try{
        await db.collection('categories').add({name, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        alert("Category added!");
      }catch(err){alert("Failed: "+(err.message||err.code));}
    });

    shareBtn.addEventListener('click', ()=>{
      if(navigator.share){
        navigator.share({
          title: "SL Skill Hub",
          text: "Find talented people near you on SL Skill Hub!",
          url: window.location.href
        }).catch(err=>console.error("Share failed:", err));
      } else {
        alert("Copy this link to share: "+window.location.href);
      }
    });

    const formWrapper=document.getElementById('formWrapper');
    openAddBtn.addEventListener('click', ()=>{
      if(!currentUser){ alert("Please login first."); return; }
      formWrapper.style.display='block';
      document.getElementById('skillForm').reset();
      document.getElementById('skillId').value='';
      photoPreview.style.display='none';
    });

    document.getElementById('skillForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("Please login first");
      const id = document.getElementById('skillId').value;
      const fileInput = document.getElementById('photoUpload');
      let photoURL = currentUser.photoURL || "";
      if (id) {
        const existingDoc = await db.collection('skills').doc(id).get();
        if (existingDoc.exists) photoURL = existingDoc.data().photoURL || photoURL;
      }
      if (fileInput.files[0]) {
        const file = fileInput.files[0];
        const storageRef = storage.ref().child(`skill_photos/${currentUser.uid}_${Date.now()}_${file.name}`);
        const snapshot = await storageRef.put(file);
        photoURL = await snapshot.ref.getDownloadURL();
      }
      const skillData = {
        uid: currentUser.uid,
        name: document.getElementById('name').value.trim(),
        skill: document.getElementById('skill').value.trim(),
        location: document.getElementById('location').value.trim(),
        whatsapp: normalizeWhatsApp(document.getElementById('whatsapp').value),
        category: document.getElementById('categorySelect').value,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        photoURL: photoURL
      };
      try{
        if(id){
          await db.collection('skills').doc(id).update(skillData);
          alert("Skill updated!");
        }else{
          await db.collection('skills').add(skillData);
          alert("Skill added!");
        }
        document.getElementById('skillForm').reset();
        formWrapper.style.display='none';
        loadSkills();
      }catch(err){
        alert("Failed: "+(err.message||err.code));
        console.error(err);
      }
    });

    const skillsArea=document.getElementById('skillsArea');
    async function loadSkills(){
      skillsArea.innerHTML='';
      const search = searchInput.value.trim().toLowerCase();
      const selectedCategory = filterCategory.value;
      let query=db.collection('skills').orderBy('createdAt','desc');
      const snapshot=await query.get();
      snapshot.forEach(doc => {
        const data = doc.data();
        if(search && !(
          data.name.toLowerCase().includes(search) ||
          data.skill.toLowerCase().includes(search) ||
          data.location.toLowerCase().includes(search)
        )) return;
        if(selectedCategory && data.category !== selectedCategory) return;
        const card = document.createElement('div');
        card.className='card';
        card.onclick = () => openProfile(data.uid);
        card.innerHTML=`
          <div class="top">
            <img src="${data.photoURL||''}" alt="profile" />
            <div>
              <h3>${data.name}</h3>
              <p><strong>Skill:</strong> ${data.skill}</p>
              <p><strong>Location:</strong> ${data.location}</p>
              <p><strong>WhatsApp:</strong> <a href="${data.whatsapp}" target="_blank">${data.whatsapp}</a></p>
              <p class="small"><strong>Category:</strong> ${data.category} | <strong>Posted:</strong> ${formatDate(data.createdAt)}</p>
            </div>
          </div>
          <div class="actions"></div>
        `;
        const actions=card.querySelector('.actions');
        if(currentUser && currentUser.uid===data.uid){
          const editBtn=document.createElement('button');
          editBtn.textContent='Edit';
          editBtn.className='btn-edit';
          editBtn.onclick=(e) => {
            e.stopPropagation();
            formWrapper.style.display='block';
            document.getElementById('skillId').value=doc.id;
            document.getElementById('name').value=data.name;
            document.getElementById('skill').value=data.skill;
            document.getElementById('location').value=data.location;
            document.getElementById('whatsapp').value=data.whatsapp.replace("https://wa.me/","");
            document.getElementById('categorySelect').value=data.category;
            document.getElementById('photoUpload').value = "";
            if(data.photoURL){
              photoPreview.src = data.photoURL;
              photoPreview.style.display = 'block';
            } else {
              photoPreview.style.display = 'none';
            }
          };
          const delBtn=document.createElement('button');
          delBtn.textContent='Delete';
          delBtn.className='btn-delete';
          delBtn.onclick=async(e)=>{
            e.stopPropagation();
            if(confirm("Are you sure to delete this skill?")){
              await db.collection('skills').doc(doc.id).delete();
              loadSkills();
            }
          };
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
        }
        skillsArea.appendChild(card);
      });
    }

    async function openProfile(uid) {
      document.getElementById("skillsArea").style.display="none";
      document.getElementById("profileView").style.display="block";
      const profileContent=document.getElementById("profileContent");
      profileContent.innerHTML="<p style='text-align:center;'>Loading profile...</p>";
      try {
        const snap=await db.collection("skills").where("uid","==",uid).orderBy("createdAt","desc").get();
        if(snap.empty){
          profileContent.innerHTML="<p>No skills found for this user.</p>";
          return;
        }
        const firstSkill=snap.docs[0].data();
        let profileHTML=`
          <div class="profile-header">
            <img src="${firstSkill.photoURL||''}" alt="${firstSkill.name}" />
            <div class="profile-info">
              <h2>${firstSkill.name}</h2>
              <p><strong>Contact:</strong> <a href="${firstSkill.whatsapp}" target="_blank">${firstSkill.whatsapp}</a></p>
              <p><strong>Total Skills:</strong> ${snap.size}</p>
            </div>
          </div>
          <h3>Skills by ${firstSkill.name}</h3>
          <div class="profile-skills">
        `;
        snap.forEach(doc=>{
          const skill=doc.data();
          profileHTML+=`
            <div class="profile-skill-card">
              <h4>${skill.skill}</h4>
              <p><strong>Category:</strong> ${skill.category}</p>
              <p><strong>Location:</strong> ${skill.location}</p>
              <p><strong>Posted:</strong> ${formatDate(skill.createdAt)}</p>
            </div>
          `;
        });
        profileHTML+='</div>';
        profileContent.innerHTML=profileHTML;
      } catch (error) {
        console.error("Error loading profile:", error);
        profileContent.innerHTML="<p>Error loading profile. Please try again.</p>";
      }
    }

    function closeProfile(){
      document.getElementById("profileView").style.display="none";
      document.getElementById("skillsArea").style.display="flex";
    }

    searchInput.addEventListener('input', loadSkills);
    filterCategory.addEventListener('change', loadSkills);
  </script>
</body>
</html>
