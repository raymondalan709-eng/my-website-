<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SL Skills Hub</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #fff;
    }
    header {
      background-color: #007BFF;
      color: white;
      padding: 15px;
      text-align: center;
      position: relative;
    }
    header img.logo {
      height: 40px;
      position: absolute;
      top: 10px;
      left: 10px;
    }
    #user-info {
      position: absolute;
      top: 10px;
      right: 10px;
      text-align: right;
    }
    #user-info img {
      border-radius: 50%;
      width: 35px;
      height: 35px;
    }
    #controls {
      margin-top: 60px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    #controls button,
    #controls input,
    #controls select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #controls button {
      background: #fff;
      color: #007BFF;
      border: 1px solid #007BFF;
      cursor: pointer;
    }
    #controls button:hover { background: #f0f4ff; }

    #addSkillForm {
      display: none;
      max-width: 400px;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }
    #addSkillForm input, #addSkillForm select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    #addSkillForm button[type="submit"] {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
    }

    #skillsContainer {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px;
      gap: 14px;
    }
    .skill-card {
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      width: 250px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .skill-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }
    .skill-card img.profile {
      border-radius: 50%;
      width: 60px;
      height: 60px;
      object-fit: cover;
    }
    .skill-card .actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    .skill-card .actions button {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .skill-card .actions button.delete {
      background-color: #e53935;
    }

    /* Mobile */
    @media (max-width: 600px) {
      #controls { margin-top: 70px; }
      header { padding-bottom: 20px; }
    }
  </style>
</head>
<body>
  <header>
    <!-- Put your SLSH logo file in the same folder and keep this filename -->
    <img src="slsh-logo.png" class="logo" alt="SL Skills Hub Logo">
    <h1>SL Skills Hub</h1>
    <p><b>find talented people near you</b></p>

    <div id="user-info">
      <div id="user-name"></div>
      <img id="user-pic" src="" alt="" style="display:none;">
      <button id="login">Login with Google</button>
      <button id="logout" style="display:none;">Logout</button>
    </div>

    <div id="controls">
      <button id="toggleAddBtn">Add a Skill</button>
      <input type="text" id="search" placeholder="Search skills...">
      <select id="categoryFilter">
        <option value="">All Categories</option>
      </select>
      <!-- Shows only for admin -->
      <button id="addCatBtn" style="display:none;">Add Category</button>
    </div>
  </header>

  <form id="addSkillForm">
    <input type="text" id="name" placeholder="Your Name" required>
    <input type="text" id="skill" placeholder="Skill" required>
    <input type="text" id="location" placeholder="Location" required>
    <input type="text" id="whatsapp" placeholder="WhatsApp Contact" required>
    <select id="category" required>
      <option value="">Select Category</option>
    </select>
    <label>Profile Picture:</label>
    <input type="file" id="profilePic" accept="image/*">
    <button type="submit">Save Skill</button>
  </form>

  <div id="skillsContainer"></div>

  <!-- Firebase compat SDKs (so firebase.* works) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBWy9ffEDL3OugOpRbHrvDjGbQ3fkPGU4Y",
      authDomain: "sl-skills-hub.firebaseapp.com",
      projectId: "sl-skills-hub",
      storageBucket: "sl-skills-hub.appspot.com",
      messagingSenderId: "125049368940",
      appId: "1:125049368940:web:76d4a47aa9eb7c43914349"
    };

    // Admin UID (shows Add Category)
    const ADMIN_UID = "I5WY1FJzNibUDOCzCBdGWPtX9Nj1";

    // Init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // UI refs
    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");
    const userName = document.getElementById("user-name");
    const userPic = document.getElementById("user-pic");
    const toggleAddBtn = document.getElementById("toggleAddBtn");
    const searchInput = document.getElementById("search");
    const skillsEl = document.getElementById("skillsContainer");
    const formEl = document.getElementById("addSkillForm");
    const catSelect = document.getElementById("category");
    const catFilter = document.getElementById("categoryFilter");
    const addCatBtn = document.getElementById("addCatBtn");

    let currentUser = null;
    let editingDocId = null;

    // Helpers
    function normalizeWhatsApp(input) {
      if (!input) return "";
      const trimmed = String(input).trim();
      if (/^https?:\/\/wa\.me\//i.test(trimmed)) return trimmed;
      let digits = trimmed.replace(/\D/g, "");
      if (digits.startsWith("0")) digits = "232" + digits.slice(1);
      if (!digits.startsWith("232") && digits.length <= 9) digits = "232" + digits;
      return "https://wa.me/" + digits;
    }
    function ownerButtonsHtml(docId, data) {
      return (currentUser && currentUser.uid === data.userId) ? `
        <div class="actions">
          <button onclick="editSkill('${docId}')">Edit</button>
          <button class="delete" onclick="deleteSkill('${docId}')">Delete</button>
        </div>` : "";
    }

    // Auth
    loginBtn.onclick = async () => {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      } catch (e) {
        alert("Login failed: " + (e.message || e.code));
      }
    };
    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(async user => {
      currentUser = user || null;
      if (user) {
        userName.textContent = user.displayName || user.email;
        userPic.src = user.photoURL || "";
        userPic.style.display = user.photoURL ? "inline-block" : "none";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        // Admin button
        addCatBtn.style.display = (user.uid === ADMIN_UID) ? "inline-block" : "none";
      } else {
        userName.textContent = "";
        userPic.style.display = "none";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        addCatBtn.style.display = "none";
      }
      await loadCategories();
      await loadSkills();
    });

    // Toggle form
    toggleAddBtn.onclick = () => {
      if (!currentUser) return alert("Please login first.");
      formEl.style.display = (formEl.style.display === "block") ? "none" : "block";
      if (!formEl.style.display || formEl.style.display === "block") {
        // if we just opened and were editing previously, keep values; else fresh
      }
    };

    // Search & filter
    searchInput.addEventListener("input", () => filterCards());
    catFilter.addEventListener("change", () => filterCards());

    function filterCards() {
      const q = searchInput.value.trim().toLowerCase();
      const cat = catFilter.value;
      document.querySelectorAll(".skill-card").forEach(card => {
        const text = card.innerText.toLowerCase();
        const matchesSearch = !q || text.includes(q);
        const matchesCat = !cat || card.dataset.category === cat;
        card.style.display = (matchesSearch && matchesCat) ? "block" : "none";
      });
    }

    // Add / Edit Skill
    formEl.onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("Please login first.");

      const name = document.getElementById("name").value.trim();
      const skill = document.getElementById("skill").value.trim();
      const location = document.getElementById("location").value.trim();
      const whatsapp = normalizeWhatsApp(document.getElementById("whatsapp").value.trim());
      const category = catSelect.value;
      const file = document.getElementById("profilePic").files[0];

      if (!name || !skill || !location || !whatsapp || !category) {
        return alert("Please fill all fields and select a category.");
      }

      let photoURL = "";
      try {
        if (file) {
          const safeName = file.name.replace(/\s+/g, "_");
          const path = `profilePics/${currentUser.uid}_${Date.now()}_${safeName}`;
          const ref = storage.ref(path);
          await ref.put(file);
          photoURL = await ref.getDownloadURL();
        }
      } catch (err) {
        alert("Image upload failed: " + (err.message || err.code));
        return;
      }

      const payload = {
        userId: currentUser.uid,
        name, skill, location,
        whatsapp, category,
        photoURL: photoURL || "", // keep empty if none
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if (editingDocId) {
          await db.collection("skills").doc(editingDocId).update(payload);
          editingDocId = null;
        } else {
          await db.collection("skills").add(payload);
        }
        formEl.reset();
        formEl.style.display = "none";
        await loadSkills();
      } catch (err) {
        alert("Save failed: " + (err.message || err.code));
      }
    };

    // Load skills
    async function loadSkills() {
      const snap = await db.collection("skills").orderBy("createdAt", "desc").get();
      skillsEl.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.data();
        const imgSrc = d.photoURL || "default.png";
        const card = document.createElement("div");
        card.className = "skill-card";
        card.dataset.category = d.category || "";
        card.innerHTML = `
          <img class="profile" src="${imgSrc}" alt="profile">
          <h3>${d.name || ""}</h3>
          <p><b>Skill:</b> ${d.skill || ""}</p>
          <p><b>Location:</b> ${d.location || ""}</p>
          <p><b>Category:</b> ${d.category || ""}</p>
          <p><b>WhatsApp:</b> <a href="${d.whatsapp || '#'}" target="_blank" rel="noopener">Chat</a></p>
          ${ownerButtonsHtml(doc.id, d)}
        `;
        skillsEl.appendChild(card);
      });
      filterCards(); // apply current search/filter
    }

    // Edit / Delete handlers (global so inline onclick works)
    window.deleteSkill = async (id) => {
      if (!confirm("Delete this skill?")) return;
      try {
        await db.collection("skills").doc(id).delete();
        await loadSkills();
      } catch (e) {
        alert("Delete failed: " + (e.message || e.code));
      }
    };

    window.editSkill = async (id) => {
      try {
        const ref = db.collection("skills").doc(id);
        const snap = await ref.get();
        if (!snap.exists) return;
        const d = snap.data();
        if (!currentUser || currentUser.uid !== d.userId) {
          return alert("You can only edit your own skill.");
        }
        editingDocId = id;
        document.getElementById("name").value = d.name || "";
        document.getElementById("skill").value = d.skill || "";
        document.getElementById("location").value = d.location || "";
        document.getElementById("whatsapp").value = (d.whatsapp || "").replace(/^https?:\/\/wa\.me\//, "");
        // category
        await loadCategories(); // ensure options exist
        catSelect.value = d.category || "";
        // open form (user can upload a new picture; if not, old URL stays if provided while saving)
        formEl.style.display = "block";
        window.scrollTo({ top: 0, behavior: "smooth" });
      } catch (e) {
        alert("Edit failed: " + (e.message || e.code));
      }
    };

    // Categories
    async function loadCategories() {
      // reset
      catSelect.innerHTML = '<option value="">Select Category</option>';
      // keep current "All Categories" option
      catFilter.innerHTML = '<option value="">All Categories</option>';

      const snap = await db.collection("categories").orderBy("name").get();
      snap.forEach(doc => {
        const name = (doc.data().name || "").trim();
        if (!name) return;
        const opt1 = document.createElement("option");
        opt1.value = name;
        opt1.textContent = name;
        catSelect.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = name;
        opt2.textContent = name;
        catFilter.appendChild(opt2);
      });
    }

    addCatBtn.onclick = async () => {
      if (!currentUser || currentUser.uid !== ADMIN_UID) {
        return alert("Only admin can add categories.");
      }
      const name = prompt("Enter new category name:");
      if (!name) return;
      try {
        await db.collection("categories").add({ name: name.trim() });
        await loadCategories();
        alert("Category added.");
      } catch (e) {
        alert("Failed to add category: " + (e.message || e.code));
      }
    };
  </script>
</body>
</html>
