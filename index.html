<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SL Skills Hub</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#fff; }

    /* Auth buttons fixed top-left */
    #auth {
      position: fixed;
      top:10px;
      left:10px;
      z-index:1000;
      text-align:center;
    }
    #auth img { width:40px; height:40px; border-radius:50%; display:block; margin-bottom:5px; }
    #auth p { margin:0; font-size:14px; color:#000; font-weight:bold; }
    #auth button { display:block; margin:5px 0; padding:5px 10px; border:none; border-radius:5px; cursor:pointer; background:#1976D2; color:#fff; }

    /* Header & search */
    header { background:#2196F3; color:#fff; padding:15px; text-align:center; margin-left:0; margin-right:0; }
    header h1 { margin:5px 0; }
    header p { margin:0; font-size:18px; font-weight:bold; }
    #searchBar { margin-top:10px; padding:8px; width:90%; max-width:500px; display:block; margin-left:auto; margin-right:auto; }

    /* Add skill form */
    #addSkillForm { margin:20px auto; width:90%; max-width:400px; background:#f5f5f5; padding:15px; border-radius:8px; }
    #addSkillForm input, #addSkillForm button { display:block; margin:10px 0; padding:8px; width:100%; }

    /* Skill cards */
    .card { border:1px solid #ccc; border-radius:8px; padding:15px; margin:10px auto; width:95%; max-width:400px; background:#fff; }
    .card img { width:50px; height:50px; border-radius:50%; display:block; margin:auto; }
    .card h3 { margin:10px 0 5px; text-align:center; }
    .card p { margin:5px 0; text-align:center; }
    .card button { margin:5px 2px; padding:5px 10px; cursor:pointer; font-size:14px; border:none; border-radius:5px; background:#1976D2; color:#fff; width:100%; }

    /* Tablet/desktop */
    @media (min-width: 768px) {
      #addSkillForm, .card { width:300px; }
      #searchBar { width:50%; }
    }

    /* Mobile */
    @media (max-width: 480px) {
      #addSkillForm { width:95%; padding:10px; }
      #searchBar { width:95%; padding:6px; font-size:14px; }
      .card { width:95%; padding:10px; }
      .card img { width:40px; height:40px; }
      .card h3 { font-size:16px; }
      .card p { font-size:14px; }
      #auth img { width:35px; height:35px; }
      #auth button { font-size:14px; padding:8px; }
    }
  </style>
</head>
<body>
  <!-- Auth top-left -->
  <div id="auth">
    <img id="userPic" src="" style="display:none;">
    <p id="userName"></p>
    <button id="loginBtn">Login with Google</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>

  <header>
    <h1>SL Skills Hub</h1>
    <p>find talented people near you</p>
    <input type="text" id="searchBar" placeholder="Search skills...">
  </header>

  <form id="addSkillForm">
    <input type="text" id="name" placeholder="Your Name" required>
    <input type="text" id="skill" placeholder="Skill" required>
    <input type="text" id="location" placeholder="Location" required>
    <input type="text" id="whatsapp" placeholder="WhatsApp Number" required>
    <button type="submit">Add Skill</button>
    <button type="button" id="categoriesBtn" style="display:none;">Add Category</button>
  </form>

  <div id="skillsList"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyBWy9ffEDL3OugOpRbHrvDjGbQ3fkPGU4Y",
  authDomain: "sl-skills-hub.firebaseapp.com",
  projectId: "sl-skills-hub",
  storageBucket: "sl-skills-hub.firebasestorage.app",
  messagingSenderId: "125049368940",
  appId: "1:125049368940:web:76d4a47aa9eb7c43914349"
};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userPic = document.getElementById("userPic");
    const userName = document.getElementById("userName");
    const addSkillForm = document.getElementById("addSkillForm");
    const skillsList = document.getElementById("skillsList");
    const searchBar = document.getElementById("searchBar");
    const categoriesBtn = document.getElementById("categoriesBtn");

    let currentUser = null;
    const adminUID = "I5WY1FJzNibUDOCzCBdGWPtX9Nj1";

    async function renderSkills() {
      const q = query(collection(db, "skills"));
      const snap = await getDocs(q);
      skillsList.innerHTML = "";
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const card = document.createElement("div");
        card.className = "card";
        const photo = data.photoURL || "https://via.placeholder.com/50";
        card.innerHTML = `
          <img src="${photo}">
          <h3>${data.name}</h3>
          <p><b>Skill:</b> ${data.skill}</p>
          <p><b>Location:</b> ${data.location}</p>
          <p><b>WhatsApp:</b> <a href="https://wa.me/${data.whatsapp.replace(/\D/g,'')}" target="_blank" style="color:#2196F3;text-decoration:none;">${data.whatsapp}</a></p>
          <p><b>Date:</b> ${data.date}</p>
        `;
        const shareBtn = document.createElement("button");
        shareBtn.innerHTML = "ðŸ”— Share";
        shareBtn.onclick = () => {
          const text = `${data.name} offers ${data.skill} in ${data.location}. Contact: ${data.whatsapp}`;
          if(navigator.share) navigator.share({title:"SL Skills Hub", text, url: window.location.href});
          else { navigator.clipboard.writeText(text + " " + window.location.href); alert("Link copied!"); }
        };
        card.appendChild(shareBtn);

        if(currentUser && data.uid === currentUser.uid){
          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.onclick = async () => {
            const newName = prompt("Edit name:", data.name);
            const newSkill = prompt("Edit skill:", data.skill);
            const newLoc = prompt("Edit location:", data.location);
            const newWA = prompt("Edit WhatsApp:", data.whatsapp);
            await updateDoc(doc(db, "skills", docSnap.id), {name:newName, skill:newSkill, location:newLoc, whatsapp:newWA});
            renderSkills();
          };
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.onclick = async () => { await deleteDoc(doc(db, "skills", docSnap.id)); renderSkills(); };
          card.appendChild(editBtn);
          card.appendChild(delBtn);
        }

        skillsList.appendChild(card);
      });
    }

    async function fixOldSkills(user) {
      const snap = await getDocs(collection(db, "skills"));
      snap.forEach(async docSnap => {
        const data = docSnap.data();
        if(!data.uid || !data.photoURL){
          await updateDoc(docSnap.ref, {uid:user.uid, photoURL:user.photoURL, displayName:user.displayName});
        }
      });
    }

    loginBtn.onclick = async () => { await signInWithPopup(auth, provider); };
    logoutBtn.onclick = async () => { await signOut(auth); };

    onAuthStateChanged(auth, async user => {
      if(user){
        currentUser=user;
        userPic.src = user.photoURL;
        userPic.style.display="block";
        userName.textContent = user.displayName;
        loginBtn.style.display="none";
        logoutBtn.style.display="block";
        categoriesBtn.style.display = (user.uid===adminUID) ? "block" : "none";
        await fixOldSkills(user);
        renderSkills();
      } else {
        currentUser=null;
        userPic.style.display="none";
        userName.textContent="";
        loginBtn.style.display="block";
        logoutBtn.style.display="none";
        categoriesBtn.style.display="none";
        renderSkills();
      }
    });

    addSkillForm.onsubmit = async e => {
      e.preventDefault();
      if(!currentUser){ alert("Login required"); return; }
      const name=document.getElementById("name").value;
      const skill=document.getElementById("skill").value;
      const location=document.getElementById("location").value;
      const whatsapp=document.getElementById("whatsapp").value;
      await addDoc(collection(db,"skills"),{
        name, skill, location, whatsapp, date:new Date().toLocaleString(),
        uid:currentUser.uid, photoURL:currentUser.photoURL, displayName:currentUser.displayName
      });
      addSkillForm.reset();
      renderSkills();
    };

    searchBar.oninput = async () => {
      const snap = await getDocs(collection(db, "skills"));
      skillsList.innerHTML="";
      snap.forEach(docSnap=>{
        const data=docSnap.data();
        if(data.name.toLowerCase().includes(searchBar.value.toLowerCase()) || data.skill.toLowerCase().includes(searchBar.value.toLowerCase())){
          const card = document.createElement("div");
          card.className="card";
          const photo = data.photoURL || "https://via.placeholder.com/50";
          card.innerHTML=`<img src="${photo}"><h3>${data.name}</h3>
            <p><b>Skill:</b> ${data.skill}</p>
            <p><b>Location:</b> ${data.location}</p>
            <p><b>WhatsApp:</b> <a href="https://wa.me/${data.whatsapp.replace(/\D/g,'')}" target="_blank" style="color:#2196F3;text-decoration:none;">${data.whatsapp}</a></p>
            <p><b>Date:</b> ${data.date}</p>`;
          const shareBtn = document.createElement("button");
          shareBtn.innerHTML = "ðŸ”— Share";
          shareBtn.onclick = () => {
            const text = `${data.name} offers ${data.skill} in ${data.location}. Contact: ${data.whatsapp}`;
            if(navigator.share) navigator.share({title:"SL Skills Hub", text, url: window.location.href});
            else { navigator.clipboard.writeText(text + " " + window.location.href); alert("Link copied!"); }
          };
          card.appendChild(shareBtn);

          if(currentUser && data.uid===currentUser.uid){
            const editBtn = document.createElement("button");
            editBtn.textContent="Edit";
            editBtn.onclick=async()=>{
              const newName=prompt("Edit name:",data.name);
              const newSkill=prompt("Edit skill:",data.skill);
              const newLoc=prompt("Edit location:",data.location);
              const newWA=prompt("Edit WhatsApp:",data.whatsapp);
              await updateDoc(doc(db,"skills",docSnap.id),{name:newName, skill:newSkill, location:newLoc, whatsapp:newWA});
              renderSkills();
            };
            const delBtn=document.createElement("button");
            delBtn.textContent="Delete";
            delBtn.onclick=async()=>{await deleteDoc(doc(db,"skills",docSnap.id)); renderSkills();};
            card.appendChild(editBtn);
            card.appendChild(delBtn);
          }

          skillsList.appendChild(card);
        }
      });
    };
  </script>
</body>
</html>
